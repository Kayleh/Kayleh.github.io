<!DOCTYPE html><!--[if IEMobile 7 ]><html class="no-js iem7" lang="zh-CN"><![endif]--><!--[if lt IE 9]><html class="no-js lte-ie8" lang="zh-CN"><![endif]--><!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="zh-CN"><!--<![endif]--><head><meta charset="UTF-8"><title>Java高性能高并发秒杀系统</title><meta name="author" content="Kayleh"><link rel="shortcut icon" href="/images/favicon.png"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1"><link rel="canonical" href="https://kayleh.top/Java-high-performance-and-high-concurrency-spike-system/"><link rel="alternate" href="/atom.xml" type="application/atom+xml"><script src="/js/modernizr-2.0.js"></script><script src="/js/jquery-1.9.1.js"></script><script>window.twttr=function(t,e,r){var n,i=t.getElementsByTagName(e)[0],w=window.twttr||{};return t.getElementById(r)||((n=t.createElement(e)).id=r,n.src="https://platform.twitter.com/widgets.js",i.parentNode.insertBefore(n,i),w._e=[],w.ready=function(t){w._e.push(t)}),w}(document,"script","twitter-wjs")</script><link rel="me" href="https://twitter.com/y40jinqing"><script src="/js/octo.js"></script><link rel="stylesheet" href="/css/octo.css"><link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"><script data-ad-client="ca-pub-7457165067653912" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?2cd1dc193190f18fed292accb735c684";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><meta name="generator" content="Hexo 4.2.0"></head><body><header role="banner"><hgroup><h1><a href="/">Kayleh</a></h1></hgroup></header><nav role="navigation"><ul class="subscription" data-subscription="rss"><li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li></ul><form action="https://google.com/search" method="get"><fieldset role="search"><input type="hidden" name="q" value="site:https://kayleh.top/"> <input class="search" type="text" name="q" results="0" placeholder="Search"></fieldset></form><ul class="main-navigation"><li><a href="/">Blog</a></li><li><a href="/archives">Archives</a></li><li><a href="/about/">about me</a></li><li><a href="/tags/">tag</a></li><li><a href="/link/">friends</a></li></ul></nav><div id="main"><div id="content"><div><article class="hentry" role="article"><header><h1 class="entry-title">Java高性能高并发秒杀系统</h1><p class="meta"><time datetime="2020-11-06T12:12:45.000Z" data-updated="true">Fri Nov 06 2020</time></p></header><div class="entry-content"><h6 id="CSDN方-圆"><a href="#CSDN方-圆" class="headerlink" title="@CSDN方 圆"></a><em>@CSDN方 圆</em></h6><h2 id="1-集成Mybatis"><a href="#1-集成Mybatis" class="headerlink" title="1. 集成Mybatis"></a>1. 集成Mybatis</h2><blockquote><p>我觉得在集成Mybatis时问题并不大</p></blockquote><h3 id="1-1-新接触的不用xml文件写Mapper文件"><a href="#1-1-新接触的不用xml文件写Mapper文件" class="headerlink" title="1.1 新接触的不用xml文件写Mapper文件"></a>1.1 新接触的不用xml文件写Mapper文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user where id = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">User <span class="title">selectById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"insert into user (id,name) values (#&#123;id&#125;,#&#123;name&#125;)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注解<code>@Mapper</code>，标记该类是一个Mapper</li><li>通常之前做练习写数据库的CRUD都是在xml文件中进行的，这次采用的是在对应的方法上标注注解的形式，<code>@Select</code> <code>@Insert</code></li></ul><h3 id="1-2-事务的测试"><a href="#1-2-事务的测试" class="headerlink" title="1.2 事务的测试"></a>1.2 事务的测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tx</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user1 = <span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"222"</span>);</span><br><span class="line">        userMapper.insertUser(user1);</span><br><span class="line"></span><br><span class="line">        User user2 = <span class="keyword">new</span> User(<span class="number">3</span>,<span class="string">"333"</span>);</span><br><span class="line">        userMapper.insertUser(user2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在UserService中，创建了一个方法，用来测试事务，用<code>@Transactional</code>标记</li></ul><h3 id="1-3-自定义一个Result类，用于返回结果使用"><a href="#1-3-自定义一个Result类，用于返回结果使用" class="headerlink" title="1.3 自定义一个Result类，用于返回结果使用"></a>1.3 自定义一个Result类，用于返回结果使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">success</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;T&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">error</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;T&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Result</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Result</span><span class="params">(<span class="keyword">int</span> code,String msg)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Result</span><span class="params">(CodeMsg codeMsg)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(codeMsg != <span class="keyword">null</span>)&#123;</span><br><span class="line">            msg = codeMsg.getMsg();</span><br><span class="line">            code = codeMsg.getCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>它包含了三个字段，<code>code用来保存状态码</code>，<code>msg状态信息</code>，<code>data是返回的对象</code>（泛型）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span>&lt;<span class="title">T</span>&gt;</span></span><br></pre></td></tr></table></figure><p>看<code>类声明的语句</code>，其中使用了泛型，这表示返回对象时，我们对其类型是“已知”的，不必强转，增加了灵活性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">success</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;T&gt;(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure><p>其中的方法语句，在<code>返回值中标记了泛型</code>，需要我们在函数定义的中在返回值前加上<code>标识泛型</code>，可以把它想象成正常的返回值，像String等等，只不过用T来表示罢了</p><p>不过，在调用这个方法的时候用两种方法</p><ol><li>直接调用 <code>Result.success(&quot;Success&quot;)</code>;</li><li>标记泛型调用，<code>Result.success(&quot;Success&quot;)</code>;</li></ol><p>两种使用方法的结果都是一样的，不过第二种更能<code>突出它是泛型方法的使用</code>，推荐。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Result</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.data = data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure><p>最后这个实在简单，在构造方法参数中使用泛型，传什么类型就自动为什么类型。</p><ul><li>最后总结一下这个Result的功能<br>1.在成功和失败的时候用于结果返回表示<br>2.另外它引入CodeMsg类，在CodeMsg类中，我们自定义了一些状态码和状态信息，用起来也比较方便</li></ul><p>下面是CodeMsg类的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeMsg</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通用错误码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CodeMsg SUCCESS = <span class="keyword">new</span> CodeMsg(<span class="number">0</span>,<span class="string">"success"</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/jpfss/p/9928747.html" target="_blank" rel="noopener">Java泛型详解：和Class的使用。泛型类，泛型方法的详细使用实例</a></p><hr><h2 id="2-集成Redis"><a href="#2-集成Redis" class="headerlink" title="2. 集成Redis"></a>2. 集成Redis</h2><h3 id="2-1-与服务器的Redis建立连接"><a href="#2-1-与服务器的Redis建立连接" class="headerlink" title="2.1 与服务器的Redis建立连接"></a>2.1 与服务器的Redis建立连接</h3><p>我们的最终目的是要创建出<code>JedisPool</code>，用来创建出Jedis与服务器中Redis进行交互</p><p>首先，需要在配置文件<code>application.properties中写好配置信息</code>，比如主机地址、端口号、最大连接数等等</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis.host=182.xxx.xxx.xxx</span><br><span class="line">redis.port=6379</span><br><span class="line">redis.timeout=3</span><br><span class="line">redis.poolMaxTotal=10</span><br><span class="line">redis.poolMaxIdle=10</span><br><span class="line">redis.poolMaxWait=3</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><p>写好配置文件，我们要对其进行读取，创建读取配置信息的配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//读取配置文件的注解,指定前缀，读以redis打头的</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"redis"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> timeout;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> poolMaxTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> poolMaxIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> poolMaxWait;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112</span></span><br></pre></td></tr></table></figure><ul><li>注意注解<code>@ConfigurationProperties(prefix = &quot;redis&quot;)</code>，用来读取前缀是redis的配置信息，字段与要读取的信息一致</li></ul><p>接下来就是要创建<code>JedisPool</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisPoolFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisConfig redisConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPool <span class="title">jedisPool</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxIdle(redisConfig.getPoolMaxIdle());</span><br><span class="line">        jedisPoolConfig.setMaxTotal(redisConfig.getPoolMaxTotal());</span><br><span class="line">        jedisPoolConfig.setEvictorShutdownTimeoutMillis(redisConfig.getTimeout() * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisPool(jedisPoolConfig,</span><br><span class="line">                redisConfig.getHost(),redisConfig.getPort(),redisConfig.getTimeout() * <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213141516</span></span><br></pre></td></tr></table></figure><p>RedisConfig，作为Bean自动装配进来，我们还要建立<code>JedisPoolConfig</code>来设置一些参数，供建立JedisPool时读取</p><p>以上，完成了与服务器Redis的建立连接过程</p><h3 id="2-2-Key前缀的必要"><a href="#2-2-Key前缀的必要" class="headerlink" title="2.2 Key前缀的必要"></a>2.2 Key前缀的必要</h3><p>毕竟我们这个是高并发的项目，那么多个人在对同一个key进行读取时，如果不对key值进行修饰，很容易发生数据损坏，所以，我们采用了<code>前缀修饰</code>，在设计模式中，是对<code>模板方法模式</code>的应用</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java高性能高并发秒杀系统/20200707171433298.png" alt="在这里插入图片描述"></p><ul><li>先创建一个<code>接口</code>，其中有两个方法，获得失效时间和获取前缀</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyPrefix</span> </span>&#123;</span><br><span class="line">    <span class="comment">//添加失效时间</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">expireSeconds</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//获取前缀</span></span><br><span class="line">    <span class="function">String <span class="title">getPrefix</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure><ul><li>随后，我们创建的是<code>抽象类</code>，它就像是一个<code>模板</code>，为其他实现该抽象类的子类，建立了一个模板（我在说什么？？？应该传达清楚了）<br>我们对接口中的方法进行全部重写，其中获取前缀时，前缀为类名，提供<code>两种构造函数</code>，一种为无失效时间的，另一种为有失效时间的</li></ul><blockquote><p>抽象类中构造方法的理解：其中的构造方法与普通类中的构造方法<code>长得一样</code>，不过它<code>不能用来构造自己</code>，因为它是抽象的，不能实例化，但是一旦子类实现了该抽象类，那么<code>子类便可以调用其抽象类的构造函数进行实例化</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePrefix</span> <span class="keyword">implements</span> <span class="title">KeyPrefix</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireSecond;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasePrefix</span><span class="params">(String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="number">0</span>,prefix);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasePrefix</span><span class="params">(<span class="keyword">int</span> expireSecond,String prefix)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expireSecond = expireSecond;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">expireSeconds</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expireSecond;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取前缀，前面添加类名</span></span><br><span class="line">        <span class="keyword">return</span> getClass().getSimpleName() + <span class="string">":"</span> + prefix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213141516171819202122232425</span></span><br></pre></td></tr></table></figure><ul><li>最后，展现出抽象类的<code>实现类</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserKey</span> <span class="keyword">extends</span> <span class="title">BasePrefix</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserKey</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//UserKey的两种前缀形式，一种是根据id另一种根据name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserKey getById = <span class="keyword">new</span> UserKey(<span class="string">"id"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserKey getByName = <span class="keyword">new</span> UserKey(<span class="string">"name"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910</span></span><br></pre></td></tr></table></figure><p>它的构造函数就是用的<code>抽象父类中的构造函数</code>，而且定义了两个静态字段，一种是根据Id来生成前缀，前缀格式会根据getPrefix()方法，表示为<code>类名+：+id</code></p><h3 id="2-3-简单看RedisService中的一个方法"><a href="#2-3-简单看RedisService中的一个方法" class="headerlink" title="2.3 简单看RedisService中的一个方法"></a>2.3 简单看RedisService中的一个方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JedisPool jedisPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">set</span><span class="params">(KeyPrefix keyPrefix,String key,T value)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取Jedis对象</span></span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">            String str = beanToString(value);</span><br><span class="line">            <span class="keyword">if</span>(str == <span class="keyword">null</span> || str.length() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String realKey = keyPrefix.getPrefix() + key;</span><br><span class="line">            <span class="keyword">int</span> seconds = keyPrefix.expireSeconds();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(seconds &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                jedis.set(realKey,str);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//设置超时时间</span></span><br><span class="line">                jedis.setex(realKey,seconds,str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            returnToPool(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011121314151617181920212223242526272829303132</span></span><br></pre></td></tr></table></figure><ol><li>根据自动装配获取<code>JedisPool</code>，用Jedis连接池来拿出<code>Jedis</code>与Redis服务器建立连接。</li><li>set方法，我们需要将<code>value值转换为String类型</code>，让Redis能够识别</li><li>随后，为key<code>添加前缀</code>，生成realKey；获取其中的失效时间</li><li>根据失效时间来判断是否需要调用<code>setex()方法</code></li></ol><h3 id="2-4-beanToString与stringToBean方法"><a href="#2-4-beanToString与stringToBean方法" class="headerlink" title="2.4 beanToString与stringToBean方法"></a>2.4 beanToString与stringToBean方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">String <span class="title">beanToString</span><span class="params">(T value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//进行类型判断，这里用到了？通配符</span></span><br><span class="line">        Class&lt;?&gt; clazz = value.getClass();</span><br><span class="line">        <span class="keyword">if</span>(clazz == <span class="keyword">int</span><span class="class">.<span class="keyword">class</span> || <span class="title">clazz</span> </span>== Integer<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span> + value;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(clazz == <span class="keyword">long</span><span class="class">.<span class="keyword">class</span> || <span class="title">clazz</span> </span>== Long<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span> + value;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(clazz == String<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (String)value;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        	<span class="comment">//如果是对象的话，用JSON的静态方法转String</span></span><br><span class="line">            <span class="keyword">return</span> JSON.toJSONString(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">1234567891011121314151617</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">stringToBean</span><span class="params">(String str,Class&lt;T&gt; clazz)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(str == <span class="keyword">null</span> || str.length() &lt;= <span class="number">0</span> || clazz == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(clazz == <span class="keyword">int</span><span class="class">.<span class="keyword">class</span> || <span class="title">clazz</span> </span>== Integer<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (T) Integer.valueOf(str);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(clazz == <span class="keyword">long</span><span class="class">.<span class="keyword">class</span> || <span class="title">clazz</span> </span>== Long<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (T) Long.valueOf(str);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(clazz == String<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (T) str;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        	<span class="comment">//转化成对象的JSON静态方法</span></span><br><span class="line">            <span class="keyword">return</span> JSON.toJavaObject(JSON.parseObject(str),clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">1234567891011121314151617</span></span><br></pre></td></tr></table></figure><ul><li>注解<code>@SupressWarings(&quot;unchecked&quot;)</code>，镇压警告</li></ul></div><footer><p class="meta"><span class="byline author vcard">Posted by <span class="fn">Kayleh</span></span> <time datetime="2020-11-06T12:12:45.000Z" data-updated="true">Fri Nov 06 2020</time> <span class="categories"><a class="category" href="/tags/project/">project</a></span></p><div class="sharing"><a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">Tweet</a></div><p class="meta"><a class="basic-alignment left" href="/Java-high-performance-and-high-concurrency-spike-system-2/index.html" title="Previous Post: Java高性能高并发秒杀系统(2)">« Java高性能高并发秒杀系统(2)</a> <a class="basic-alignment right" href="/file-input-and-output/index.html" title="Previous Post: file input and output">file input and output »</a></p></footer></article><section><h1>Comments</h1><div id="disqus_thread"></div><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript><script>var canonicalUrl="https://kayleh.top/Java-high-performance-and-high-concurrency-spike-system/",disqus_config=function(){this.page.url=canonicalUrl,this.page.identifier=canonicalUrl};!function(){var e=document,a=e.createElement("script");a.src="https://kayleh.disqus.com/embed.js",a.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(a)}()</script></section></div><aside class="sidebar"><section class="odd"><h1>Recent Posts</h1><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/null/">前端安全</a></li><li class="post-list-item"><a class="post-list-link" href="/What-happened-from-entering-the-URL-to-displaying-the-page?/">What happened from entering the URL to displaying the page?</a></li><li class="post-list-item"><a class="post-list-link" href="/Download/">Download</a></li><li class="post-list-item"><a class="post-list-link" href="/app-test/">app test</a></li><li class="post-list-item"><a class="post-list-link" href="/interface-test/">interface test</a></li><li class="post-list-item"><a class="post-list-link" href="/Unitest-framework/">Unitest framework</a></li><li class="post-list-item"><a class="post-list-link" href="/automated-test-katalon/">Katalon Recorder (Selenium tests generator)</a></li><li class="post-list-item"><a class="post-list-link" href="/dynamic-programming/">Dynamic programming动态规划</a></li><li class="post-list-item"><a class="post-list-link" href="/automated-test-selenium/">automated test：selenium</a></li><li class="post-list-item"><a class="post-list-link" href="/test-case/">Test case</a></li></ul></section><section class="even"><h1>GitHub Repos</h1><ul id="gh_repos"><li class="loading">Status updating&#8230;</li></ul><a href="https://github.com/kayleh" target="_blank" rel="noopener">@kayleh</a> on GitHub<script>$(document).ready(function(){
            const options = {
                user: 'kayleh',
                count: 0,
                skip_forks: true,
                target: '#gh_repos'
            }

            function escapeHtml(str) {
                return $('<div/>').text(str).html();
            }

            function render(target, repos){
                let i, fragment = '', t = $(target)[0];

                for(i = 0; i < repos.length; i++) {
                    fragment += '<li><a href="'+repos[i].html_url+'">'+repos[i].name+'</a><p>'+escapeHtml(repos[i].description||'')+'</p></li>';
                }
                t.innerHTML = fragment;
            }

            $.ajax({
                url: "https://api.github.com/users/"+options.user+"/repos?sort=pushed&callback=?",
                dataType: 'jsonp',
                error: function (err) {
                    $(options.target + ' li.loading').addClass('error').text("Error loading feed");
                },
                success: function(data) {
                    var repos = [];
                    if (!data || !data.data) { return; }
                    for (var i = 0; i < data.data.length; i++) {
                        if (options.skip_forks && data.data[i].fork) { continue; }
                        repos.push(data.data[i]);
                    }
                    if (options.count) { repos.splice(options.count); }
                    render(options.target, repos);
                }
            });
        });</script></section></aside></div></div><footer role="contentinfo"><p>Copyright © 2021 - Kayleh -</p></footer><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7457165067653912" data-ad-slot="7430854225" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></body></html>