<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sentinel实现熔断与限流 | Kayleh</title><meta name="description" content="Sentinel  是什么Hystrix 下载https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;Sentinel&#x2F;releases  怎么使用？https:&#x2F;&#x2F;spring-cloud-alibaba-group.github.io&#x2F;github-pages&#x2F;greenwich&#x2F;spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel 服"><meta name="keywords" content="DistributedMicroservices"><meta name="author" content="Kayleh"><meta name="copyright" content="Kayleh"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/favicon.png"><link rel="canonical" href="https://kayleh.top/Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="preconnect" href="//zz.bdstatic.com"><meta name="google-site-verification" content="LQn0xwjfEU_V6CXCA0qAdwM4qRXtblIbfy5KuzEKaRg"><meta property="og:type" content="article"><meta property="og:title" content="Sentinel实现熔断与限流"><meta property="og:url" content="https://kayleh.top/Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81/"><meta property="og:site_name" content="Kayleh"><meta property="og:description" content="Sentinel  是什么Hystrix 下载https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;Sentinel&#x2F;releases  怎么使用？https:&#x2F;&#x2F;spring-cloud-alibaba-group.github.io&#x2F;github-pages&#x2F;greenwich&#x2F;spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel 服"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index4.jpg"><meta property="article:published_time" content="2020-08-24T05:18:27.000Z"><meta property="article:modified_time" content="2021-04-11T17:11:28.416Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '1'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-7457165067653912",enable_page_level_ads:"true"})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?24f5d46da7ff42ae73ccea4ea7114e1b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG={root:"/",hexoversion:"4.2.0",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:{limitDay:10,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},bookmark:{message_prev:"按",message_next:"键将本页加入书签"},runtime_unit:"天",runtime:!1,copyright:void 0,ClickShowText:void 0,medium_zoom:!0,fancybox:!1,Snackbar:void 0,justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},baiduPush:!0,highlightCopy:!0,highlightLang:!0,isPhotoFigcaption:!1,islazyload:!0,isanchor:!0}</script><script id="config_change">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isSidebar:!0,postUpdate:"2021-04-12 01:11:28"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}</style></noscript><meta http-equiv="Content-Type" content="text/html;charset=gb2312"><meta name="sogou_site_verification" content="7uatD8cGg5"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Kayleh" type="application/atom+xml"><link rel="stylesheet" href="/css/prism.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/2.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">190</div></a></div></div><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="https://home.kayleh.top/" target="_blank" rel="noopener"><i class="fa-fw fa fa-reply"></i><span> return</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="https://shell.kayleh.top/" target="_blank" rel="noopener"><i class="fa-fw fa fa-bolt"></i><span> shell</span></a></div><div class="menus_item"><a class="site-page" href="/en"><i class="fa-fw fa fa-info-circle"></i><span> English</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/about"><i class="fa-fw fa fa-id-card"></i><span> 我?</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="mailto:kaylehisdied@gmail.com"><i class="fa-fw fa fa-envelope"></i><span> mail</span></a></li><li><a class="site-page" href="/2020/06/11/RESUME/"><i class="fa-fw fa fa-envelope-open"></i><span> resume</span></a></li></ul></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#是什么"><span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载"><span class="toc-text">下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么使用？"><span class="toc-text">怎么使用？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#服务使用中的各种问题"><span class="toc-text">服务使用中的各种问题</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Sentinel控制台"><span class="toc-text">安装Sentinel控制台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sentinel组件由2部分组成"><span class="toc-text">sentinel组件由2部分组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装步骤"><span class="toc-text">安装步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载-1"><span class="toc-text">下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行命令"><span class="toc-text">运行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问sentinel管理界面"><span class="toc-text">访问sentinel管理界面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化演示工程"><span class="toc-text">初始化演示工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Module"><span class="toc-text">Module</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#cloudalibaba-sentinel-service8401"><span class="toc-text">cloudalibaba-sentinel-service8401</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#POM"><span class="toc-text">POM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#YML"><span class="toc-text">YML</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#主启动"><span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#业务类FlowLimitController"><span class="toc-text">业务类FlowLimitController</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动Sentinel8080"><span class="toc-text">启动Sentinel8080</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动微服务8401"><span class="toc-text">启动微服务8401</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动8401微服务后查看sentienl控制台"><span class="toc-text">启动8401微服务后查看sentienl控制台</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel采用的懒加载说明"><span class="toc-text">Sentinel采用的懒加载说明</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#效果"><span class="toc-text">效果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#结论"><span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流控规则"><span class="toc-text">流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本介绍"><span class="toc-text">基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流控模式"><span class="toc-text">流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接（默认）"><span class="toc-text">直接（默认）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#直接-gt-快速失败"><span class="toc-text">直接-&gt;快速失败</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置及说明"><span class="toc-text">配置及说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#关联"><span class="toc-text">关联</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#是什么？"><span class="toc-text">是什么？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置A"><span class="toc-text">配置A</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#postman模拟并发密集访问testB"><span class="toc-text">postman模拟并发密集访问testB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#运行后发现testA挂了"><span class="toc-text">运行后发现testA挂了</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#链路"><span class="toc-text">链路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流控效果"><span class="toc-text">流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接-gt-快速失败（默认的流控处理）"><span class="toc-text">直接-&gt;快速失败（默认的流控处理）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#预热"><span class="toc-text">预热</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#说明"><span class="toc-text">说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#官网"><span class="toc-text">官网</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#源码"><span class="toc-text">源码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Warmup配置"><span class="toc-text">Warmup配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#多次点击http-localhost-8401-testB"><span class="toc-text">多次点击http:&#x2F;&#x2F;localhost:8401&#x2F;testB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#应用场景"><span class="toc-text">应用场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#排队等待"><span class="toc-text">排队等待</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#匀速排队，阈值必须设置为QPS"><span class="toc-text">匀速排队，阈值必须设置为QPS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#官网-1"><span class="toc-text">官网</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#源码-1"><span class="toc-text">源码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试-1"><span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#降级规则"><span class="toc-text">降级规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本介绍-1"><span class="toc-text">基本介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Sentinel的断路器是没有半开状态的"><span class="toc-text">Sentinel的断路器是没有半开状态的</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#降级策略实战"><span class="toc-text">降级策略实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RT"><span class="toc-text">RT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#是什么-1"><span class="toc-text">是什么?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试-2"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常比例"><span class="toc-text">异常比例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常数"><span class="toc-text">异常数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#热点key限流"><span class="toc-text">热点key限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本介绍-2"><span class="toc-text">基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#承上启下复习start"><span class="toc-text">承上启下复习start</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码"><span class="toc-text">代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-3"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#参数例外项"><span class="toc-text">参数例外项</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#测试-4"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#前提条件"><span class="toc-text">前提条件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他"><span class="toc-text">其他,</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#系统规则"><span class="toc-text">系统规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SentinelResource"><span class="toc-text">@SentinelResource</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#按资源名称限流-后续处理"><span class="toc-text">按资源名称限流+后续处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#按照Url地址限流-后续处理"><span class="toc-text">按照Url地址限流+后续处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上面兜底方法面临的问题"><span class="toc-text">上面兜底方法面临的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户自定义限流处理逻辑"><span class="toc-text">客户自定义限流处理逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更多注解属性说明"><span class="toc-text">更多注解属性说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务熔断功能"><span class="toc-text">服务熔断功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sentinel整合ribbon-openFeign-fallback"><span class="toc-text">sentinel整合ribbon+openFeign+fallback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon系列"><span class="toc-text">Ribbon系列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动nacos和sentinel"><span class="toc-text">启动nacos和sentinel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#提供者9003-9004"><span class="toc-text">提供者9003&#x2F;9004</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消费者84"><span class="toc-text">消费者84</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Feign系列"><span class="toc-text">Feign系列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#熔断框架比较"><span class="toc-text">熔断框架比较</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#规则持久化"><span class="toc-text">规则持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#是什么-2"><span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#怎么玩"><span class="toc-text">怎么玩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤"><span class="toc-text">步骤</span></a></li></ol></li></ol></li></div></div></div><header class="post-bg" id="page-header" style="background-image:url(https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index4.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Kayleh</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="https://home.kayleh.top/" target="_blank" rel="noopener"><i class="fa-fw fa fa-reply"></i><span> return</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="https://shell.kayleh.top/" target="_blank" rel="noopener"><i class="fa-fw fa fa-bolt"></i><span> shell</span></a></div><div class="menus_item"><a class="site-page" href="/en"><i class="fa-fw fa fa-info-circle"></i><span> English</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/about"><i class="fa-fw fa fa-id-card"></i><span> 我?</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="mailto:kaylehisdied@gmail.com"><i class="fa-fw fa fa-envelope"></i><span> mail</span></a></li><li><a class="site-page" href="/2020/06/11/RESUME/"><i class="fa-fw fa fa-envelope-open"></i><span> resume</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Sentinel实现熔断与限流</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-24T05:18:27.000Z" title="发表于 2020-08-24 13:18:27">2020-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-11T17:11:28.416Z" title="更新于 2021-04-12 01:11:28">2021-04-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>Sentinel</p><a id="more"></a><h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><p>Hystrix</p><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/1.png" alt="1598275246796"></p><h3 id="怎么使用？"><a href="#怎么使用？" class="headerlink" title="怎么使用？"></a>怎么使用？</h3><p><a href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel" target="_blank" rel="noopener">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel</a></p><h4 id="服务使用中的各种问题"><a href="#服务使用中的各种问题" class="headerlink" title="服务使用中的各种问题"></a>服务使用中的各种问题</h4><blockquote><p>服务雪崩</p><p>服务降级</p><p>服务熔断</p><p>服务限流</p></blockquote><h2 id="安装Sentinel控制台"><a href="#安装Sentinel控制台" class="headerlink" title="安装Sentinel控制台"></a>安装Sentinel控制台</h2><h3 id="sentinel组件由2部分组成"><a href="#sentinel组件由2部分组成" class="headerlink" title="sentinel组件由2部分组成"></a>sentinel组件由2部分组成</h3><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/2.png" alt="1598275337431"></p><blockquote><p>后台</p><p>前台8080</p></blockquote><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><blockquote><p><a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a></p><p>下载到本地sentinel-dashboard-1.7.0.jar</p></blockquote><h4 id="运行命令"><a href="#运行命令" class="headerlink" title="运行命令"></a>运行命令</h4><p>前提:</p><ul><li>java8环境OK</li><li>8080端口不能被占用</li></ul><p>命令:</p><pre class="line-numbers language-lang-cmd"><code class="language-lang-cmd">java -jar sentinel-dashboard-1.7.0.jar
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="访问sentinel管理界面"><a href="#访问sentinel管理界面" class="headerlink" title="访问sentinel管理界面"></a>访问sentinel管理界面</h4><blockquote><p><a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a></p><p>登录账号密码均为sentinel</p></blockquote><h2 id="初始化演示工程"><a href="#初始化演示工程" class="headerlink" title="初始化演示工程"></a>初始化演示工程</h2><p>启动Nacos8848成功</p><blockquote><p><a href="http://localhost:8848/nacos/#/login" target="_blank" rel="noopener">http://localhost:8848/nacos/#/login</a></p></blockquote><h4 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h4><h5 id="cloudalibaba-sentinel-service8401"><a href="#cloudalibaba-sentinel-service8401" class="headerlink" title="cloudalibaba-sentinel-service8401"></a>cloudalibaba-sentinel-service8401</h5><h5 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h5><pre class="line-numbers language-lang-xml"><code class="language-lang-xml">    <dependencies>
        <dependency>
            <groupid>com.atguigu.springcloud</groupid>
            <artifactid>cloud-api-commons</artifactid>
            <version>${project.version}</version>
        </dependency>

        <dependency>
            <groupid>com.alibaba.cloud</groupid>
            <artifactid>spring-cloud-starter-alibaba-nacos-discovery</artifactid>
        </dependency>

        <dependency>
            <groupid>com.alibaba.csp</groupid>
            <artifactid>sentinel-datasource-nacos</artifactid>
        </dependency>

        <dependency>
            <groupid>com.alibaba.cloud</groupid>
            <artifactid>spring-cloud-starter-alibaba-sentinel</artifactid>
        </dependency>

        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-openfeign</artifactid>
        </dependency>

        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-web</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-actuator</artifactid>
        </dependency>

        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-devtools</artifactid>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>cn.hutool</groupid>
            <artifactid>hutool-all</artifactid>
            <version>4.6.3</version>
        </dependency>
        <dependency>
            <groupid>org.projectlombok</groupid>
            <artifactid>lombok</artifactid>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-test</artifactid>
            <scope>test</scope>
        </dependency>

    </dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="YML"><a href="#YML" class="headerlink" title="YML"></a>YML</h5><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
      #nacos服务注册中心地址
        server-addr: localhost:8848
    sentinel:
      transport:
        dashboard: localhost:8080
        port: 8719  #默认8719，假如被占用了会自动从8719开始依次+1扫描。直至找到未被占用的端口

management:
  endpoints:
    web:
      exposure:
        include: '*'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="主启动"><a href="#主启动" class="headerlink" title="主启动"></a>主启动</h5><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;


@EnableDiscoveryClient
@SpringBootApplication
public class MainApp8401
{
    public static void main(String[] args) {
        SpringApplication.run(MainApp8401.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="业务类FlowLimitController"><a href="#业务类FlowLimitController" class="headerlink" title="业务类FlowLimitController"></a>业务类FlowLimitController</h5><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class FlowLimitController
{
    @GetMapping("/testA")
    public String testA() {
        return "------testA";
    }

    @GetMapping("/testB")
    public String testB() {

        return "------testB";
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="启动Sentinel8080"><a href="#启动Sentinel8080" class="headerlink" title="启动Sentinel8080"></a>启动Sentinel8080</h4><pre class="line-numbers language-lang-java"><code class="language-lang-java">java -jar sentinel-dashboard-1.7.0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="启动微服务8401"><a href="#启动微服务8401" class="headerlink" title="启动微服务8401"></a>启动微服务8401</h4><h4 id="启动8401微服务后查看sentienl控制台"><a href="#启动8401微服务后查看sentienl控制台" class="headerlink" title="启动8401微服务后查看sentienl控制台"></a>启动8401微服务后查看sentienl控制台</h4><p>空空如也，啥都没有</p><h3 id="Sentinel采用的懒加载说明"><a href="#Sentinel采用的懒加载说明" class="headerlink" title="Sentinel采用的懒加载说明"></a>Sentinel采用的懒加载说明</h3><p>执行一次访问即可</p><p><a href="http://localhost:8401/testA" target="_blank" rel="noopener">http://localhost:8401/testA</a></p><p><a href="http://localhost:8401/testB" target="_blank" rel="noopener">http://localhost:8401/testB</a></p><h5 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h5><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/3.png" alt="1598275789442"></p><h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p>sentinel8080正在监控微服务8401</p><h2 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h2><h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/4.png" alt="1598275892803"></p><p>进一步解释说明</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/5.png" alt="1598275917235"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/6.png" alt="1598275930554"></p><h3 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h3><h4 id="直接（默认）"><a href="#直接（默认）" class="headerlink" title="直接（默认）"></a>直接（默认）</h4><h5 id="直接-gt-快速失败"><a href="#直接-gt-快速失败" class="headerlink" title="直接-&gt;快速失败"></a>直接-&gt;快速失败</h5><ul><li>系统默认</li></ul><h5 id="配置及说明"><a href="#配置及说明" class="headerlink" title="配置及说明"></a>配置及说明</h5><h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/7.png" alt="1598276075851">测试</h5><pre><code>快速点击访问http://localhost:8401/testA
</code></pre><p>结果</p><p>Blocked by Sentinel (flow limiting)</p><p>思考？？？</p><p>直接调用默认报错信息，技术方面OK but，是否应该有我们自己的后续处理？</p><p>类似有一个fallback的兜底方法？</p><h4 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h4><h5 id="是什么？"><a href="#是什么？" class="headerlink" title="是什么？"></a>是什么？</h5><p>当关联的资源达到阈值时，就限流自己</p><p>当与A关联的资源B达到阈值后，就限流自己</p><p>B惹事，A挂了</p><h5 id="配置A"><a href="#配置A" class="headerlink" title="配置A"></a>配置A</h5><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/8.png" alt="1598276511243"></p><h5 id="postman模拟并发密集访问testB"><a href="#postman模拟并发密集访问testB" class="headerlink" title="postman模拟并发密集访问testB"></a>postman模拟并发密集访问testB</h5><p>先把请求save as，保存到Collections</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/9.png" alt="1598276562818"></p><p>访问testB成功</p><ul><li><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/10.png" alt="1598276623255"></li></ul><p>postman里新建多线程集合组</p><ul><li><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/11.png" alt="1598276640905"></li></ul><p>将访问地址添加进新线程组</p><ul><li><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/12.png" alt="1598276659894"></li></ul><p>Run</p><ul><li>大批量线程高并发访问B，导致A失效了</li></ul><h5 id="运行后发现testA挂了"><a href="#运行后发现testA挂了" class="headerlink" title="运行后发现testA挂了"></a>运行后发现testA挂了</h5><blockquote><p>点击访问<a href="http://localhost:8401/testA" target="_blank" rel="noopener">http://localhost:8401/testA</a></p><p>结果</p><p>Blocked by Sentinel (flow limiting)</p></blockquote><h4 id="链路"><a href="#链路" class="headerlink" title="链路"></a>链路</h4><p>多个请求调用了同一个微服务</p><p>家庭作业试试</p><h3 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h3><h4 id="直接-gt-快速失败（默认的流控处理）"><a href="#直接-gt-快速失败（默认的流控处理）" class="headerlink" title="直接-&gt;快速失败（默认的流控处理）"></a>直接-&gt;快速失败（默认的流控处理）</h4><p>直接失败，抛出异常</p><ul><li>Blocked by Sentinel (flow limiting)</li></ul><p>源码</p><ul><li>com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController</li></ul><h4 id="预热"><a href="#预热" class="headerlink" title="预热"></a>预热</h4><h5 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h5><ul><li>公式：阈值除以coldFactor（默认值为3），经过预热时长后才会达到阈值</li></ul><h5 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h5><ul><li><p>默认coldFactor为3，即请求QPS从threshold/3开始，经预热时长逐渐升至设定的QPS阈值。</p></li><li><p>限流 冷启动</p><p><a href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8</a></p></li></ul><h5 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h5><p>com.alibaba.csp.sentinel.slots.block.flow.controller.WarmUpController</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/14.png" alt="1598276768339"></p><h5 id="Warmup配置"><a href="#Warmup配置" class="headerlink" title="Warmup配置"></a>Warmup配置</h5><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/15.png" alt="1598277103340"></p><h5 id="多次点击http-localhost-8401-testB"><a href="#多次点击http-localhost-8401-testB" class="headerlink" title="多次点击http://localhost:8401/testB"></a>多次点击<a href="http://localhost:8401/testB" target="_blank" rel="noopener">http://localhost:8401/testB</a></h5><ul><li>刚开始不行，后续慢慢OK</li></ul><h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/16.png" alt="1598277148535"></p><h4 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h4><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/13.png" alt="1598276768339"></p><h5 id="匀速排队，阈值必须设置为QPS"><a href="#匀速排队，阈值必须设置为QPS" class="headerlink" title="匀速排队，阈值必须设置为QPS"></a>匀速排队，阈值必须设置为QPS</h5><h5 id="官网-1"><a href="#官网-1" class="headerlink" title="官网"></a>官网</h5><h5 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h5><p>com.alibaba.csp.sentinel.slots.block.flow.controller.RateLimiterController</p><h5 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h5><p>testB在控制台输出日志sl4j</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">log.info(thread.currentThread.getName()+"\t"+"...testB")
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/17.png" alt="1598277222170"></p><h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a>降级规则</h3><h4 id="基本介绍-1"><a href="#基本介绍-1" class="headerlink" title="基本介绍"></a>基本介绍</h4><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/18.png" alt="1598277395163"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/19.png" alt="1598277412123"></p><p>进一步说明</p><h5 id="Sentinel的断路器是没有半开状态的"><a href="#Sentinel的断路器是没有半开状态的" class="headerlink" title="Sentinel的断路器是没有半开状态的"></a>Sentinel的断路器是没有半开状态的</h5><blockquote><p>半开的状态系统自动去检测是否请求有异常，没有异常就关闭断路器恢复使用，有异常则继续打开断路器不可用。具体可以参考Hystrix</p></blockquote><p>复习Hystrix</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/20.png" alt="1598277556742"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/21.png" alt="1598277592247"></p><h3 id="降级策略实战"><a href="#降级策略实战" class="headerlink" title="降级策略实战"></a>降级策略实战</h3><h4 id="RT"><a href="#RT" class="headerlink" title="RT"></a>RT</h4><h5 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么?"></a>是什么?</h5><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/22.png" alt="1598277795422"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/23.png" alt="1598277815933"></p><h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h5><p>代码</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">    @GetMapping("/testD")
    public String testD()
    {
        try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); }
        log.info("testD 测试RT");

        return "------testD";
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/24.png" alt="1598277885759"></p><p>jmeter压测</p><p>结论</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/25.png" alt="1598277904111"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/26.png" alt="1598277918812"></p><h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><p>是什么</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/27.png" alt="1598277953235"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/28.png" alt="1598277965489"></p><p>测试</p><ul><li><p>代码</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@GetMapping("/testD")
    public String testD()
    {

        log.info("testD 测试RT");
        int age = 10/0;
        return "------testD";
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>配置</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/29.png" alt="1598278071559"></p></li><li><p>jmeter</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/30.png" alt="1598278103683"></p></li><li><p>结论</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/1598278121021.png" alt="1598278121021"></p></li></ul><h4 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h4><p>是什么</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/31.png" alt="1598278157875"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/32.png" alt="1598278172535"></p><p>异常数是按照分钟统计的</p><p>测试</p><ul><li>代码</li></ul><pre class="line-numbers language-lang-java"><code class="language-lang-java">@GetMapping("/testE")
public String testE()
{
    log.info("testE 测试异常数");
    int age = 10/0;
    return "------testE 测试异常数";
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>配置</li></ul><p><a href="http://localhost:8401/testE" target="_blank" rel="noopener">http://localhost:8401/testE</a></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/33.png" alt="1598278242551"></p><ul><li>jmeter</li></ul><h2 id="热点key限流"><a href="#热点key限流" class="headerlink" title="热点key限流"></a>热点key限流</h2><h4 id="基本介绍-2"><a href="#基本介绍-2" class="headerlink" title="基本介绍"></a>基本介绍</h4><p>是什么</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/34.png" alt="1598281015660"></p><p><a href="https://github.com/alibaba/Sentinel/wiki/热点参数限流" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/热点参数限流</a></p><h4 id="承上启下复习start"><a href="#承上启下复习start" class="headerlink" title="承上启下复习start"></a>承上启下复习start</h4><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/35.png" alt="1598281047415"></p><p>@SentinelResource</p><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><pre class="line-numbers language-lang-java"><code class="language-lang-java">@GetMapping("/testHotKey")
@SentinelResource(value = "testHotKey",blockHandler = "deal_testHotKey")
public String testHotKey(@RequestParam(value = "p1",required = false) String p1,
                         @RequestParam(value = "p2",required = false) String p2) {
    //int age = 10/0;
    return "------testHotKey";
}

//兜底方法
public String deal_testHotKey (String p1, String p2, BlockException exception){
    return "------deal_testHotKey,o(╥﹏╥)o";  
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>com.alibaba.csp.sentinel.slots.block.BlockException</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>配置</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/36.png" alt="1598281119051"></p><p>1</p><p>@SentinelResource(value = “testHotKey”)</p><p>异常打到了前台用户界面看不到，不友好</p><p>2</p><p>@SentinelResource(value = “testHotKey”,blockHandler = “deal_testHotKey”)</p><p>方法testHostKey里面第一个参数只要QPS超过每秒1次，马上降级处理</p><p>用了我们自己定义的</p><h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><p>:x: error</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">http://localhost:8401/testHotKey?p1=abc
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>:x: error</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">http://localhost:8401/testHotKey?p1=abc&p2=33
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>:heavy_check_mark: right</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">http://localhost:8401/testHotKey?p2=abc
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="参数例外项"><a href="#参数例外项" class="headerlink" title="参数例外项"></a>参数例外项</h4><p>上述案例演示了第一个参数p1,当QPS超过1秒1次点击后马上被限流</p><p>特殊情况</p><blockquote><p>普通</p><ul><li>超过1秒钟一个后，达到阈值1后马上被限流</li></ul><p>我们期望p1参数当它是某个特殊值时，它的限流值和平时不一样</p><p>特例</p><ul><li>假如当p1的值等于5时，它的阈值可以达到200</li></ul></blockquote><p>配置</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/37.png" alt="1598281694486"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/38.png" alt="1598281694486"></p><ul><li>添加按钮不能忘</li></ul><h5 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h5><blockquote><p>:heavy_check_mark: <a href="http://localhost:8401/testHotKey?p1=5" target="_blank" rel="noopener">http://localhost:8401/testHotKey?p1=5</a></p><p>:x:<a href="http://localhost:8401/testHotKey?p1=3" target="_blank" rel="noopener">http://localhost:8401/testHotKey?p1=3</a></p><p>当p1等于5的时候，阈值变为200</p><p>当p1不等于5的时候，阈值就是平常的1</p></blockquote><h5 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h5><p>热点参数的注意点，参数必须是基本类型或者String</p><h4 id="其他"><a href="#其他" class="headerlink" title="其他,"></a>其他,</h4><p>添加异常看看….</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/39.png" alt="1598281913264"></p><h2 id="系统规则"><a href="#系统规则" class="headerlink" title="系统规则"></a>系统规则</h2><p>是什么？</p><blockquote><p><a href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</a></p></blockquote><p>各项配置参数说明</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/40.png" alt="1598337022929"></p><p>配置全局QPS</p><h2 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="@SentinelResource"></a>@SentinelResource</h2><h3 id="按资源名称限流-后续处理"><a href="#按资源名称限流-后续处理" class="headerlink" title="按资源名称限流+后续处理"></a>按资源名称限流+后续处理</h3><p>启动Nacos成功</p><p>启动Sentinel成功</p><p>Module</p><blockquote><p>cloudalibaba-sentinel-service8401</p><p>POM</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependency>
    <groupid>com.atguigu.springcloud</groupid>
    <artifactid>cloud-api-commons</artifactid>
    <version>${project.version}</version>
</dependency>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    sentinel:
      transport:
        dashboard: localhost:8080
        port: 8719  #默认8719，假如被占用了会自动从8719开始依次+1扫描。直至找到未被占用的端口

management:
  endpoints:
    web:
      exposure:
        include: '*'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>业务类RateLimitController</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba.controller;

import com.alibaba.csp.sentinel.annotation.SentinelResource;
import com.alibaba.csp.sentinel.slots.block.BlockException;

import com.atguigu.springcloud.entities.*;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;


@RestController
public class RateLimitController
{
    @GetMapping("/byResource")
    @SentinelResource(value = "byResource",blockHandler = "handleException")
    public CommonResult byResource()
    {
        return new CommonResult(200,"按资源名称限流测试OK",new Payment(2020L,"serial001"));
    }
    public CommonResult handleException(BlockException exception)
    {
        return new CommonResult(444,exception.getClass().getCanonicalName()+"\t 服务不可用");
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主启动</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;


@EnableDiscoveryClient
@SpringBootApplication
public class MainApp8401
{
    public static void main(String[] args) {
        SpringApplication.run(MainApp8401.class, args);
    }

}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><p>配置流控规则</p><ul><li>配置步骤</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/41.png" alt="1598337203454"></p><ul><li>图形配置和代码关系</li><li>表示1秒钟内查询次数大于1，就跑到我们自定义的处流，限流</li></ul><p>测试</p><ul><li><p>1秒钟点击1下，OK</p></li><li><p>超过上述问题，疯狂点击，返回了自己定义的限流处理信息，限流发送</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/42.png" alt="1598337235793"></p></li></ul><p>额外问题</p><ul><li><p>此时关闭微服务8401看看</p></li><li><p>Sentinel控制台，流控规则消失了？？</p><p>临时/持久？</p></li></ul><h3 id="按照Url地址限流-后续处理"><a href="#按照Url地址限流-后续处理" class="headerlink" title="按照Url地址限流+后续处理"></a>按照Url地址限流+后续处理</h3><p>通过访问的URL来限流，会返回Sentinel自带默认的限流处理信息</p><p>业务类RateLimitController</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@GetMapping("/rateLimit/byUrl")
@SentinelResource(value = "byUrl")
public CommonResult byUrl()
{
    return new CommonResult(200,"按url限流测试OK",new Payment(2020L,"serial002"));
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>访问一次</p><p>Sentinel控制台配置</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/43.png" alt="1598337354555"></p><p>测试</p><ul><li><p>疯狂点击<a href="http://localhost:8401/rateLimit/byUrl" target="_blank" rel="noopener">http://localhost:8401/rateLimit/byUrl</a></p></li><li><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/44.png" alt="1598337380401"></p></li></ul><h3 id="上面兜底方法面临的问题"><a href="#上面兜底方法面临的问题" class="headerlink" title="上面兜底方法面临的问题"></a>上面兜底方法面临的问题</h3><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/45.png" alt="1598337405346"></p><h3 id="客户自定义限流处理逻辑"><a href="#客户自定义限流处理逻辑" class="headerlink" title="客户自定义限流处理逻辑"></a>客户自定义限流处理逻辑</h3><p>创建customerBlockHandler类用于自定义限流处理逻辑</p><p>自定义限流处理类</p><ul><li><p>CustomerBlockHandler</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/46.png" alt="1598337444808"></p></li></ul><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba.myhandler;

import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.atguigu.springcloud.entities.*;

public class CustomerBlockHandler {

    public static CommonResult handleException(BlockException exception) {
        return new CommonResult(2020, "自定义限流处理信息....CustomerBlockHandler");

    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RateLimitController</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@GetMapping("/rateLimit/customerBlockHandler")
@SentinelResource(value = "customerBlockHandler",
        blockHandlerClass = CustomerBlockHandler.class,
        blockHandler = "handlerException2")
public CommonResult customerBlockHandler()
{
    return new CommonResult(200,"按客戶自定义",new Payment(2020L,"serial003"));
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动微服务后先调用一次</p><blockquote><p><a href="http://localhost:8401/rateLimit/customerBlockHandler" target="_blank" rel="noopener">http://localhost:8401/rateLimit/customerBlockHandler</a></p></blockquote><p>Sentinel控制台配置</p><p>测试后我们自定义的出来了</p><p>进一步说明:</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/47.png" alt="1598337533657"></p><h3 id="更多注解属性说明"><a href="#更多注解属性说明" class="headerlink" title="更多注解属性说明"></a>更多注解属性说明</h3><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/48.png" alt="1598337561019"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/49.png" alt="1598337573475"></p><p>多说一句</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/50.png" alt="1598337587461"></p><p>Sentinel主要有三个核心API</p><ul><li><p>SphU定义资源</p></li><li><p>Tracer定义统计</p></li><li><p>ContextUtil定义了上下文</p></li></ul><h2 id="服务熔断功能"><a href="#服务熔断功能" class="headerlink" title="服务熔断功能"></a>服务熔断功能</h2><h3 id="sentinel整合ribbon-openFeign-fallback"><a href="#sentinel整合ribbon-openFeign-fallback" class="headerlink" title="sentinel整合ribbon+openFeign+fallback"></a>sentinel整合ribbon+openFeign+fallback</h3><h3 id="Ribbon系列"><a href="#Ribbon系列" class="headerlink" title="Ribbon系列"></a>Ribbon系列</h3><h4 id="启动nacos和sentinel"><a href="#启动nacos和sentinel" class="headerlink" title="启动nacos和sentinel"></a>启动nacos和sentinel</h4><h4 id="提供者9003-9004"><a href="#提供者9003-9004" class="headerlink" title="提供者9003/9004"></a>提供者9003/9004</h4><blockquote><p>新建cloudalibaba-provider-payment9003/9004</p><p>POM</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependencies>
    
    <dependency>
        <groupid>com.alibaba.cloud</groupid>
        <artifactid>spring-cloud-starter-alibaba-nacos-discovery</artifactid>
    </dependency>
    <dependency>
        <groupid>com.atguigu.springcloud</groupid>
        <artifactid>cloud-api-commons</artifactid>
        <version>${project.version}</version>
    </dependency>
    
    <dependency>
        <groupid>org.springframework.boot</groupid>
        <artifactid>spring-boot-starter-web</artifactid>
    </dependency>
    <dependency>
        <groupid>org.springframework.boot</groupid>
        <artifactid>spring-boot-starter-actuator</artifactid>
    </dependency>
    
    <dependency>
        <groupid>org.springframework.boot</groupid>
        <artifactid>spring-boot-devtools</artifactid>
        <scope>runtime</scope>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupid>org.projectlombok</groupid>
        <artifactid>lombok</artifactid>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupid>org.springframework.boot</groupid>
        <artifactid>spring-boot-starter-test</artifactid>
        <scope>test</scope>
    </dependency>
</dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 9003

spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #配置Nacos地址

management:
  endpoints:
    web:
      exposure:
        include: '*'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>记得修改不同的端口号</li></ul><p>主启动</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;


@SpringBootApplication
@EnableDiscoveryClient
public class PaymentMain9003
{
    public static void main(String[] args) {
        SpringApplication.run(PaymentMain9003.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>业务类</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba.controller;

import com.atguigu.springcloud.alibaba.entities.CommonResult;
import com.atguigu.springcloud.alibaba.entities.Payment;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;

@RestController
public class PaymentController
{
    @Value("${server.port}")
    private String serverPort;

    public static HashMap<long , payment> hashMap = new HashMap<>();
    static{
        hashMap.put(1L,new Payment(1L,"28a8c1e3bc2742d8848569891fb42181"));
        hashMap.put(2L,new Payment(2L,"bba8c1e3bc2742d8848569891ac32182"));
        hashMap.put(3L,new Payment(3L,"6ua8c1e3bc2742d8848569891xt92183"));
    }

    @GetMapping(value = "/paymentSQL/{id}")
    public CommonResult<payment> paymentSQL(@PathVariable("id") Long id){
        Payment payment = hashMap.get(id);
        CommonResult<payment> result = new CommonResult(200,"from mysql,serverPort:  "+serverPort,payment);
        return result;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></payment></payment></long></code></pre><p>测试地址</p><pre><code>http://localhost:9003/paymentSQL/1
</code></pre></blockquote><h4 id="消费者84"><a href="#消费者84" class="headerlink" title="消费者84"></a>消费者84</h4><blockquote><p>新建cloudalibaba-consumer-nacos-order84</p><p>POM</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml">    <dependencies>
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-openfeign</artifactid>
        </dependency>
        <dependency>
            <groupid>com.alibaba.cloud</groupid>
            <artifactid>spring-cloud-starter-alibaba-nacos-discovery</artifactid>
        </dependency>
        <dependency>
            <groupid>com.alibaba.cloud</groupid>
            <artifactid>spring-cloud-starter-alibaba-sentinel</artifactid>
        </dependency>
        <dependency>
            <groupid>com.atguigu.springcloud</groupid>
            <artifactid>cloud-api-commons</artifactid>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-web</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-actuator</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-devtools</artifactid>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.projectlombok</groupid>
            <artifactid>lombok</artifactid>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-test</artifactid>
            <scope>test</scope>
        </dependency>
    </dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>YML</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 84


spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    sentinel:
      transport:
        dashboard: localhost:8080
        port: 8719

service-url:
  nacos-user-service: http://nacos-payment-provider
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主启动</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;


@EnableDiscoveryClient
@SpringBootApplication
@EnableFeignClients
public class OrderNacosMain84
{
    public static void main(String[] args) {
        SpringApplication.run(OrderNacosMain84.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>业务类</p><p>ApplicationContextConfig</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;


@Configuration
public class ApplicationContextConfig
{
    @Bean
    @LoadBalanced
    public RestTemplate getRestTemplate()
    {
        return new RestTemplate();
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>CircleBreakerController的全部源码</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba.controller;

import com.alibaba.csp.sentinel.annotation.SentinelResource;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.atguigu.springcloud.alibaba.entities.CommonResult;
import com.atguigu.springcloud.alibaba.entities.Payment;

import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import javax.annotation.Resource;


@RestController
@Slf4j
public class CircleBreakerController {

    public static final String SERVICE_URL = "http://nacos-payment-provider";

    @Resource
    private RestTemplate restTemplate;

    @RequestMapping("/consumer/fallback/{id}")
    //@SentinelResource(value = "fallback") //没有配置
    //@SentinelResource(value = "fallback",fallback = "handlerFallback") //fallback只负责业务异常
    //@SentinelResource(value = "fallback",blockHandler = "blockHandler") //blockHandler只负责sentinel控制台配置违规
    @SentinelResource(value = "fallback",fallback = "handlerFallback",blockHandler = "blockHandler",
            exceptionsToIgnore = {IllegalArgumentException.class})
    public CommonResult<payment> fallback(@PathVariable Long id) {
        CommonResult<payment> result = restTemplate.getForObject(SERVICE_URL + "/paymentSQL/"+id, CommonResult.class,id);

        if (id == 4) {
            throw new IllegalArgumentException ("IllegalArgumentException,非法参数异常....");
        }else if (result.getData() == null) {
            throw new NullPointerException ("NullPointerException,该ID没有对应记录,空指针异常");
        }

        return result;
    }

    //fallback
    public CommonResult handlerFallback(@PathVariable  Long id,Throwable e) {
        Payment payment = new Payment(id,"null");
        return new CommonResult<>(444,"兜底异常handlerFallback,exception内容  "+e.getMessage(),payment);
    }

    //blockHandler
    public CommonResult blockHandler(@PathVariable  Long id,BlockException blockException) {
        Payment payment = new Payment(id,"null");
        return new CommonResult<>(445,"blockHandler-sentinel限流,无此流水: blockException  "+blockException.getMessage(),payment);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></payment></payment></code></pre><p>修改后请重启微服务</p><ul><li>热部署对java代码级生效及时</li><li>对@SentinelResource注解内属性，有时效果不好</li></ul><p>目的</p><ul><li>fallback管运行异常</li><li>blockHandler管配置违规</li></ul><p>测试地址</p><ul><li><a href="http://localhost:84/consumer/fallback/1" target="_blank" rel="noopener">http://localhost:84/consumer/fallback/1</a></li></ul><p>没有任何配置</p><ul><li>给客户error页面，不友好</li></ul><p>只配置fallback</p><ul><li>编码（那个业务类下面的CircleBreakerController的全部源码）</li></ul><p>只配置blockHandler</p><ul><li>编码（那个业务类下面的CircleBreakerController的全部源码）</li></ul><p>fallback和blockHandler都配置</p><ul><li><p>结果</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/51.png" alt="1598338239282"></p></li></ul><p>忽略属性…</p><ul><li><p>编码（那个业务类下面的CircleBreakerController的全部源码）</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/52.png" alt="1598338281914"></p></li></ul></blockquote></blockquote><h3 id="Feign系列"><a href="#Feign系列" class="headerlink" title="Feign系列"></a>Feign系列</h3><p>修改84模块</p><p>POM</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependency>
    <groupid>org.springframework.cloud</groupid>
    <artifactid>spring-cloud-starter-openfeign</artifactid>
</dependency>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 84


spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    sentinel:
      transport:
        dashboard: localhost:8080
        port: 8719

service-url:
  nacos-user-service: http://nacos-payment-provider

#对Feign的支持
feign:
  sentinel:
    enabled: true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>业务类</p><ul><li><p>带@FeignClient注解的业务接口</p><p>```java<br>package com.atguigu.springcloud.alibaba.service;</p></li></ul><p>import com.atguigu.springcloud.alibaba.entities.CommonResult;<br>import com.atguigu.springcloud.alibaba.entities.Payment;<br>import org.springframework.cloud.openfeign.FeignClient;<br>import org.springframework.web.bind.annotation.GetMapping;<br>import org.springframework.web.bind.annotation.PathVariable;</p><p>@FeignClient(value = “nacos-payment-provider”,fallback = PaymentFallbackService.class)<br>public interface PaymentService<br>{<br>@GetMapping(value = “/paymentSQL/{id}”)<br>public CommonResult<payment>paymentSQL(@PathVariable(“id”) Long id);<br>}</payment></p><pre><code>
- fallback = PaymentFallbackService.class

- PaymentFallbackService实现类

  ```java
  package com.atguigu.springcloud.alibaba.service;

  import com.atguigu.springcloud.alibaba.entities.CommonResult;
  import com.atguigu.springcloud.alibaba.entities.Payment;
  import org.springframework.stereotype.Component;

  @Component
  public class PaymentFallbackService implements PaymentService
  {
      @Override
      public CommonResult&lt;Payment&gt; paymentSQL(Long id)
      {
          return new CommonResult&lt;&gt;(44444,&quot;服务降级返回,---PaymentFallbackService&quot;,new Payment(id,&quot;errorSerial&quot;));
      }
  }
</code></pre><ul><li><p>Controller</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">// OpenFeign
@Resource
private PaymentService paymentService;

@GetMapping(value = "/consumer/paymentSQL/{id}")
public CommonResult<payment> paymentSQL(@PathVariable("id") Long id) {
    return paymentService.paymentSQL(id);
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></payment></code></pre></li></ul><p>主启动</p><p>添加@EnableFeignClients启动Feign的功能</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.atguigu.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@EnableDiscoveryClient
@SpringBootApplication
@EnableFeignClients
public class OrderNacosMain84
{
    public static void main(String[] args) {
        SpringApplication.run(OrderNacosMain84.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="http://lcoalhost:84/consumer/openfeign/1" target="_blank" rel="noopener">http://lcoalhost:84/consumer/openfeign/1</a></p><p><a href="http://lcoalhost:84/consumer/paymentSQL/1" target="_blank" rel="noopener">http://lcoalhost:84/consumer/paymentSQL/1</a></p><p>测试84调用9003，此时故意关闭9003微服务提供者，看84消费侧自动降级，不会被耗死</p><h4 id="熔断框架比较"><a href="#熔断框架比较" class="headerlink" title="熔断框架比较"></a>熔断框架比较</h4><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/53.png" alt="1598339929387"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/54.png" alt="1598339942749"></p><h3 id="规则持久化"><a href="#规则持久化" class="headerlink" title="规则持久化"></a>规则持久化</h3><h4 id="是什么-2"><a href="#是什么-2" class="headerlink" title="是什么"></a>是什么</h4><p>一旦我们重启应用，Sentinel规则将消失，生产环境需要将配置规则进行持久化</p><h4 id="怎么玩"><a href="#怎么玩" class="headerlink" title="怎么玩"></a>怎么玩</h4><p>将限流配置规则持久化进Nacos保存，只要刷新8401某个rest地址，sentinel控制台的流控规则就能看到，只要Nacos里面的配置不删除，针对8401上Sentinel上的流控规则持续有效</p><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><p>修改cloudalibaba-sentinel-service8401</p><p>POM</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependency>
    <groupid>com.alibaba.csp</groupid>
    <artifactid>sentinel-datasource-nacos</artifactid>
</dependency>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>YML</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #Nacos服务注册中心地址
    sentinel:
      transport:
        dashboard: localhost:8080 #配置Sentinel dashboard地址
        port: 8719
      datasource:
        ds1:
          nacos:
            server-addr: localhost:8848
            dataId: cloudalibaba-sentinel-service
            groupId: DEFAULT_GROUP
            data-type: json
            rule-type: flow

management:
  endpoints:
    web:
      exposure:
        include: '*'

feign:
  sentinel:
    enabled: true # 激活Sentinel对Feign的支持
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加Nacos数据源配置</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">spring:
   cloud:
    sentinel:
    datasource:
     ds1:
      nacos:
        server-addr:localhost:8848
        dataid:${spring.application.name}
        groupid:DEFAULT_GROUP
        data-type:json
            rule-type:flow
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加Nacos业务规则配置</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/55.png" alt="1598340101146"></p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/56.png" alt="1598340112967"></p><p>内容解析</p><pre class="line-numbers language-lang-json"><code class="language-lang-json">[
    {
         "resource": "/retaLimit/byUrl",
         "limitApp": "default",
         "grade":   1,
         "count":   1,
         "strategy": 0,
         "controlBehavior": 0,
         "clusterMode": false    
    }
]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/57.png" alt="1598340151536"></p><p>启动8401后刷新sentinel发现业务规则有了</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/58.png" alt="1598340340265"></p><p>快速访问测试接口</p><ul><li><p><a href="http://localhost:8401/rateLimit/byUrl" target="_blank" rel="noopener">http://localhost:8401/rateLimit/byUrl</a></p></li><li><p>默认</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/59.png" alt="图像"></p></li></ul><p>停止8401再看sentinel</p><p><img src="/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/Sentinel实现熔断与限流/60.png" alt="1598340454693"></p><p>重新启动8401再看sentinel:</p><p>扎一看还是没有，稍等一会儿</p><p>多次调用</p><blockquote><p><a href="http://localhost:8401/rateLimit/byUrl" target="_blank" rel="noopener">http://localhost:8401/rateLimit/byUrl</a></p></blockquote><p>重新配置出现了，持久化验证通过</p></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Kayleh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kayleh.top/Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81/">https://kayleh.top/Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kayleh.top" target="_blank">Kayleh</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/DistributedMicroservices/">DistributedMicroservices</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f41058e8051f381" async></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/wechatpay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/wechatpay.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/alipay.jpg" alt="alipay"></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><div class="post-ad"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7457165067653912" data-ad-slot="9837525717" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Seata%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index3.jpg" onerror='onerror=null,src="/img/404.jpg"'><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Seata处理分布式事务</div></div></a></div><div class="next-post pull-right"><a href="/gulp%E5%8E%8B%E7%BC%A9%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index4.jpg" onerror='onerror=null,src="/img/404.jpg"'><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">gulp压缩静态资源</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/Nacos服务注册和配置中心/" title="Nacos服务注册和配置中心"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index2.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-21</div><div class="relatedPosts_title">Nacos服务注册和配置中心</div></div></a></div><div class="relatedPosts_item"><a href="/Seata处理分布式事务/" title="Seata处理分布式事务"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index3.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-26</div><div class="relatedPosts_title">Seata处理分布式事务</div></div></a></div><div class="relatedPosts_item"><a href="/分布式的微服务架构4/" title="GateWay服务限流"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index5.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-14</div><div class="relatedPosts_title">GateWay服务限流</div></div></a></div><div class="relatedPosts_item"><a href="/分布式的微服务架构2/" title="Eureka服务注册与发现"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-14</div><div class="relatedPosts_title">Eureka服务注册与发现</div></div></a></div><div class="relatedPosts_item"><a href="/分布式的微服务架构3/" title="Ribbon负载均衡服务调用、服务降级"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index3.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-14</div><div class="relatedPosts_title">Ribbon负载均衡服务调用、服务降级</div></div></a></div><div class="relatedPosts_item"><a href="/分布式的微服务架构1/" title="SpringCloud"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-03</div><div class="relatedPosts_title">SpringCloud</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image:url(https://cdn.jsdelivr.net/gh/kayleh/cdn/img/index4.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Kayleh</div><div class="footer_custom_text">all rights reserved.</div></div><div style="text-align:center"><a href="https://info.flagcounter.com/cDh1" target="_blank" rel="noopener"><img src="https://s11.flagcounter.com/count/cDh1/bg_49B1F5/txt_000000/border_49B1F5/columns_4/maxflags_16/viewers_0/labels_1/pageviews_0/flags_0/percent_1/" alt="Flag Counter" border="0"></a></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'FgNaybmwy1yu74JH4lXMgH5S-gzGzoHsz',
      appKey: 'OBHyEdMVsi8FSFA0aqJNh4HE',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,document.body.addEventListener("input",POWERMODE)</script><script src="/js/third-party/click_heart.js" async></script><script>!function(t,e,o,c,n,i,a){t.DaoVoiceObject=n,t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},t[n].l=+new Date,i=e.createElement(o),a=e.getElementsByTagName(o)[0],i.async=1,i.src=c,i.charset="utf-8",a.parentNode.insertBefore(i,a)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/38b1c911.js","daovoice")</script><script>var isChatBtn = false
daovoice('init', {
  app_id: '38b1c911',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script></div><script src="/live2d-widget/autoload.js"></script></body></html>