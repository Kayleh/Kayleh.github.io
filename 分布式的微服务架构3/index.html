<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Kayleh"><title>Ribbon负载均衡服务调用、服务降级 · Kayleh</title><meta name="description" content="Ribbon负载均衡服务调用、服务降级 


LB(负载均衡)

集中式LB即在服务的消费方和提供方之间使用独立的LB设施(可以是硬件,如F5,也可以是软件,如nginx),由该设施负责把访问请求通过某种策略转发至服务的提供方.
进程内LB将逻辑集成到消费方,消费方从服务注册中心获知有哪些地址可用,"><meta name="keywords" content=""><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style-dark.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">Kayleh</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">活版印字</a></h1></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">대문</a></li><li><a href="/archives">아카이브</a></li><li><a href="/categories">카테고리</a></li><li><a href="/tags">태그</a></li><li><a href="/google8102e2f35ce9e391.html"></a></li><li><a href="/mainfest.json"></a></li><li><a href="/categories/categories.html"></a></li><li><a href="/about/index.html">about</a></li><li><a href="/link/index.html">友人帐</a></li><li class="soc"><a href="https://github.com/kayleh" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://twitter.com/kayleh" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter">&nbsp;</i></a><a href="https://www.instagram.com/kayleh" target="_blank" rel="noopener noreferrer"><i class="fa fa-instagram">&nbsp;</i></a><a href="https://kayleh.top/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="https://kayleh.top" rel="noopener noreferrer">Kayleh</a></p><span>visitors:<span id="busuanzi_value_site_pv"></span></span></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>Ribbon负载均衡服务调用、服务降级</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2020-08-14</span><span class="meta-item"><i class="fa fa-comment-o"></i><span>&nbsp;</span><a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%843/#comments">덧글</a></span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/DistributedMicroservices/" title="DistributedMicroservices" class="a-tag">DistributedMicroservices</a><span>&nbsp;</span></span></p><p class="post-abstract"></p><p>Ribbon负载均衡服务调用、服务降级</p><a id="more"></a><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596715648722.png" alt="1596715648722"></p><p>LB(负载均衡)</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596726399842.png" alt="1596726399842"></p><h3 id="集中式LB"><a href="#集中式LB" class="headerlink" title="集中式LB"></a>集中式LB</h3><p>即在服务的消费方和提供方之间使用独立的LB设施(可以是硬件,如F5,也可以是软件,如nginx),由该设施负责把访问请求通过某种策略转发至服务的提供方.</p><h3 id="进程内LB"><a href="#进程内LB" class="headerlink" title="进程内LB"></a>进程内LB</h3><p>将逻辑集成到消费方,消费方从服务注册中心获知有哪些地址可用,然后自己再从这些地址中选择出一个合适的服务器.</p><p>Ribbon就属于进程内LB,它只是一个类库,集成于消费方进程,消费方通过它来获取服务提供方的地址.</p><blockquote><p>就是 负载均衡+RestTemplate调用.</p></blockquote><h3 id="负载均衡演示"><a href="#负载均衡演示" class="headerlink" title="负载均衡演示"></a>负载均衡演示</h3><p>Ribbon其实就是一个软负载均衡的客户端组件,他可以和其他所需请求的客户端结合使用,和eureka结合只是其中的一个实例.</p><h4 id="架构"><a href="#架构" class="headerlink" title="架构:"></a>架构:</h4><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596727154050.png" alt=" "></p><p>Ribbon工作时分成两步</p><p>第一步先选择EurekaServer,它优先选择在同一区域内负载较少的server</p><p>第二步再根据用户指定的策略,在从server取到的服务注册列表中选择一个地址.</p><p>其中Ribbon提供了多种策略:比如轮询,随机和根据响应时间加权.</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596727714256.png" alt="1596727714256"></p><p>新版的eureka整合了Ribbon</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-netflix-ribbon</artifactid>
</dependency>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h4><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596728066428.png" alt="1596728066428"></p><p>getForObject和getForEntity:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596728100814.png" alt="1596728100814"></p><pre class="line-numbers language-lang-java"><code class="language-lang-java">     @GetMapping("/consumer/payment/get/{id}")
    public CommonResult<payment> getPayment(@PathVariable("id") Long id) {
        return restTemplate.getForObject(PAYMENT_URL + "/payment/get/" + id, CommonResult.class);
    }

    @GetMapping("/consumer/payment/getForEntity/{id}")
    public CommonResult<payment> getPayment2(@PathVariable("id") Long id) {
        ResponseEntity<commonresult> entity = restTemplate.getForEntity(PAYMENT_URL + "/payment/get/" + id, CommonResult.class);

        if (entity.getStatusCode().is2xxSuccessful()) {
            log.info(entity.getStatusCode()+"\t"+entity.getHeaders());
            return entity.getBody();
        } else {
            return new CommonResult<>(444,"操作失败");
        }
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></commonresult></payment></payment></code></pre><h4 id="IRule：根据特定算法中从服务列表中选取一个要访问的服务"><a href="#IRule：根据特定算法中从服务列表中选取一个要访问的服务" class="headerlink" title="IRule：根据特定算法中从服务列表中选取一个要访问的服务"></a>IRule：根据特定算法中从服务列表中选取一个要访问的服务</h4><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596781514760.png" alt="1596781514760"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596781613909.png" alt="1596781613909"></p><p>修改cloyud-consumer-order80</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596781758399.png" alt="1596781758399"></p><p>@SpringBootApplication里有@ComponentScan注解,不能和主启动类放在同一包下</p><p>新建package com.kayleh.myrule</p><p>新建MySelfRule</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.myrule;

import com.netflix.loadbalancer.IRule;
import com.netflix.loadbalancer.RandomRule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * @Author: Wizard
 * @Date: 2020/8/7 14:33
 */
@Configuration
public class MySelfRule {
    @Bean
    public IRule myRule() {
        return new RandomRule();//定义为随机
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主启动类添加@RibbonClient</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@SpringBootApplication
@EnableEurekaClient
@RibbonClient(name = "CLOUD-PAYMENT-SERVICE", configuration = MySelfRule.class)
public class OrderMain80 {
    public static void main(String[] args) {
        SpringApplication.run(OrderMain80.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre><code>http://localhost/consumer/payment/get/1
</code></pre><h4 id="Ribbon负载均衡算法"><a href="#Ribbon负载均衡算法" class="headerlink" title="Ribbon负载均衡算法"></a>Ribbon负载均衡算法</h4><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596786871454.png" alt="1596786871454"></p><h4 id="Ribbon手写轮询算法"><a href="#Ribbon手写轮询算法" class="headerlink" title="Ribbon手写轮询算法"></a>Ribbon手写轮询算法</h4><blockquote></blockquote><h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><p>Feign是一个声明式WebService客户端。使用Feign能让编写Web Service客户端更加简单。</p><p>它的使用方法是定义一个服务接口然后在上面添加注解。Feign也支持可拔插式的编码器和解码器。Spring Cloud对Feign进行了封装，使其支持了Spring MVC标准注解和HttpMessageConverters。Feign可以与Eureka和Ribbon组合使用以支持负载均衡。</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596790462395.png" alt="1596790462395"></p><h5 id="feign和OpenFeign"><a href="#feign和OpenFeign" class="headerlink" title="feign和OpenFeign"></a>feign和OpenFeign</h5><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596803520990.png" alt="1596803520990"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596811655732.png" alt="1596811655732"></p><h3 id="OpenFeign服务调用"><a href="#OpenFeign服务调用" class="headerlink" title="OpenFeign服务调用"></a>OpenFeign服务调用</h3><h4 id="接口-注解"><a href="#接口-注解" class="headerlink" title="接口+注解"></a><strong>接口+注解</strong></h4><p>新建cloud-consumer-feign-order80</p><p>pom.xml</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependencies>
        
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-openfeign</artifactid>
        </dependency>
           
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-netflix-eureka-client</artifactid>
        </dependency>
        <dependency>
            <groupid>com.kayleh.springcloud</groupid>
            <artifactid>cloud-api-commons</artifactid>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-web</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-actuator</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-devtools</artifactid>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.projectlombok</groupid>
            <artifactid>lombok</artifactid>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-test</artifactid>
            <scope>test</scope>
        </dependency>
    </dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 80

eureka:
  client:
    register-with-eureka: false
    service-url:
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主启动类：</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud;

/**
 * @Author: Wizard
 * @Date: 2020/8/4 11:20
 */
@SpringBootApplication
@EnableFeignClients
public class OrderFeignMain80 {
    public static void main(String[] args) {
        SpringApplication.run(OrderFeignMain80.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Service:</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.service;

@Component
@FeignClient("CLOUD-PAYMENT-SERVICE")
public interface PaymentFeignService {

    @GetMapping(value = "/payment/get/{id}")
    public CommonResult<payment> getPaymentById(@PathVariable("id") Long id);

}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></payment></code></pre><p>Controller</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.controller;

@RestController
@Slf4j
public class OrderFeignController {

    @Resource
    private PaymentFeignService paymentFeignService;

    @GetMapping(value = "/consumer/payment/get/{id}")
    public CommonResult<payment> getPaymentById(@PathVariable("id") Long id) {
        return paymentFeignService.getPaymentById(id);

    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></payment></code></pre><p>测试</p><pre><code>http://localhost/consumer/payment/get/1
</code></pre><h3 id="OpenFeign超时控制"><a href="#OpenFeign超时控制" class="headerlink" title="OpenFeign超时控制"></a>OpenFeign超时控制</h3><p>修改cloud-provider-payment8001的controller，添加</p><pre><code> @GetMapping(value = &quot;/payment/feign/timeout&quot;)
    public String getPaymentFeignTimeout() {
        //暂停几秒钟线程
        try {
            TimeUnit.SECONDS.sleep(3);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return serverPort;
    }
</code></pre><p>cloud-consumer-feign-order80的PaymentFeignService接口：</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@Component
@FeignClient("CLOUD-PAYMENT-SERVICE")
public interface PaymentFeignService {

    @GetMapping(value = "/payment/get/{id}")
    public CommonResult<payment> getPaymentById(@PathVariable("id") Long id);

    @GetMapping(value = "/payment/feign/timeout")
    public String getPaymentFeignTimeout();
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></payment></code></pre><p>cloud-consumer-feign-order80的OrderFeignController，添加：</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@GetMapping(value = "/consumer/payment/feign/timeout")
    public String getPaymentFeignTimeout() {
        //客户端默认等待1秒钟
        return paymentFeignService.getPaymentFeignTimeout();
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>访问</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">http://localhost:8001/payment/feign/timeout
http://localhost/consumer/payment/feign/timeout #报错
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596809432122.png" alt="1596809432122"></p><blockquote><p>OpenFeign默认支持Ribbon</p><p>OpenFeign默认等待1秒钟，超过后报错</p><p>默认Feign客户端只等待1秒钟,但是服务端处理需要等待超过1秒钟,导致Feign客户端不想等待了,直接返回报错.</p><p>为了避免这样的情况,有时候我们需要设置Feign客户端的超时控制.</p><p>yml文件中开启配置</p></blockquote><p>修改cloud-consumer-feign-order80的yaml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 80

eureka:
  client:
    register-with-eureka: false
    service-url:
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/

#设置feign客户端超时时间(OpenFeign默认支持Ribbon)
ribbon:
  #指的是建立连接所用的时间,使用于网络状况正常的情况下,两端连接所用的时间
  ReadTimeout: 5000
  #指的是建立连接后从服务端读取到可用资源所用的时间
  ConnectTimeout: 5000
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再测试</p><pre><code>http://localhost/consumer/payment/feign/timeout
</code></pre><h3 id="OpenFeign日志打印功能"><a href="#OpenFeign日志打印功能" class="headerlink" title="OpenFeign日志打印功能"></a>OpenFeign日志打印功能</h3><p>Feign提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解Feign中Http请求的细节。说白了就是对Feign接口的调用情况进行监控和输出</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596812081019.png" alt="1596812081019"></p><p>在cloud-consumer-feign-order80的FeignConfig中添加</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.config;

import feign.Logger;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

/**
 * @Author: Wizard
 * @Date: 2020/8/4 12:54
 */
@Configuration
public class FeignConfig {
    @Bean
    Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改yaml文件</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 80

eureka:
  client:
    register-with-eureka: false
    service-url:
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/

#设置feign客户端超时时间(OpenFeign默认支持Ribbon)
ribbon:
  #指的是建立连接所用的时间,使用于网络状况正常的情况下,两端连接所用的时间
  ReadTimeout: 5000
  #指的是建立连接后从服务端读取到可用资源所用的时间
  ConnectTimeout: 5000
logging:
  level:
    # feign以什么级别监控哪个接口
    com.kayleh.springcloud.service.PaymentFeignService: debug
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>即可开启日志功能。</p><h1 id="Hystrix服务调用"><a href="#Hystrix服务调用" class="headerlink" title="Hystrix服务调用"></a>Hystrix服务调用</h1><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596861908224.png" alt="1596861908224"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596861970345.png" alt="1596861970345"></p><h3 id="案例"><a href="#案例" class="headerlink" title="案例:"></a>案例:</h3><p>新建cloud-provider-hystrix-payment8001</p><p>pom.xml</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"> <dependencies>
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-netflix-hystrix</artifactid>
        </dependency>
        
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-netflix-eureka-client</artifactid>
        </dependency>

        <dependency>
            <groupid>com.kayleh.springcloud</groupid>
            <artifactid>cloud-api-commons</artifactid>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-web</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-actuator</artifactid>
        </dependency>
        
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-devtools</artifactid>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.projectlombok</groupid>
            <artifactid>lombok</artifactid>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-test</artifactid>
        </dependency>
    </dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 8001

spring:
  application:
    name: cloud-provider-hystrix-payment

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #      defaultZone: http://localhost:7001/eureka/
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>service</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.service;
import com.kayleh.springcloud.entities.Payment;
import org.apache.ibatis.annotations.Param;
import org.springframework.stereotype.Service;
import java.util.concurrent.TimeUnit;
@Service
public class PaymentService {
    public String paymentInfo_OK(Integer id) {
        return "线程池: " + Thread.currentThread().getName() + "  paymentInfo_OK,id:  " + id + "\t" + "O(∩_∩)O哈哈~";
    }

    public String paymentInfo_TimeOut(Integer id) {
        //暂停3秒钟
        int timeNumber = 3;
        try {
            TimeUnit.SECONDS.sleep(timeNumber);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return "线程池: " + Thread.currentThread().getName() + "  paymentInfo_TimeOut,id:  " + id + "\t" + "o(╥﹏╥)o哭" + "耗时" + timeNumber + "秒钟";
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>controller</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@RestController
@Slf4j
public class PaymentController {

    @Resource
    private PaymentService paymentService;

    @Value("${server.port}")
    private String serverPort;

    @PostMapping(value = "/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id) {
        String result = paymentService.paymentInfo_OK(id);
        log.info("----------result:" + result);
        return result;
    }

    @GetMapping(value = "/payment/hystrix/timeout/{id}")
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
        String result = paymentService.paymentInfo_TimeOut(id);
        log.info("----------result:" + result);
        return result;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre><code>localhost:8001/payment/hystrix/ok/{id}
localhost:8001/payment/hystrix/timeout/{id}
</code></pre><p>以上述为根基平台，从正确 —&gt;错误 —&gt; 降级熔断 —&gt; 恢复</p><h5 id="Jmeter压测测试"><a href="#Jmeter压测测试" class="headerlink" title="Jmeter压测测试"></a>Jmeter压测测试</h5><p>开启 Jmeter，来20000个并发压死8001，20000个请求都去访问paymentInfo_TimeOut</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596866230258.png" alt="1596866230258"></p><p><a href="http://localhost:8001/payment/hystrix/timeout/1" target="_blank" rel="noopener">http://localhost:8001/payment/hystrix/timeout/1</a></p><p>这时访问</p><pre><code>http://localhost:8001/payment/hystrix/ok/1
</code></pre><p>访问开始变慢了</p><p>这只是服务提供者8001自己测试，假如此时外部的消费者80也来访问，那消费者只能干等，最终导致消费端80不满意，服务端8001直接被拖死。</p><p>新建cloud-consumer-feign-hystrix-order80</p><p>pom.xml</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml"><dependencies>
        
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-openfeign</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-netflix-hystrix</artifactid>
        </dependency>
        
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-starter-netflix-eureka-client</artifactid>
        </dependency>
        <dependency>
            <groupid>com.kayleh.springcloud</groupid>
            <artifactid>cloud-api-commons</artifactid>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-web</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-actuator</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-devtools</artifactid>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.projectlombok</groupid>
            <artifactid>lombok</artifactid>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-test</artifactid>
            <scope>test</scope>
        </dependency>
    </dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
  port: 80

eureka:
  client:
    register-with-eureka: false
    service-url:
      #      defaultZone: http://localhost:7001/eureka/
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>service接口，调用cloud-provider-hystrix-payment8001里的方法</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.service;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

/**
 * @Author: Wizard
 * @Date: 2020/8/7 20:54
 */
@Component
@FeignClient("CLOUD-PROVIDER-HYSTRIX-PAYMENT")
public interface PaymentHystrixService {

    @GetMapping(value = "/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id);

    @GetMapping(value = "/payment/hystrix/timeout/{id}")
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id);

}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>controller</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.controller;

@RestController
@Slf4j
public class OrderHystrixController {

    @Resource
    private PaymentHystrixService paymentFeignService;

    @GetMapping(value = "/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id) {
        return paymentFeignService.paymentInfo_OK(id);
    }

    @GetMapping(value = "/payment/hystrix/timeout/{id}")
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
        return paymentFeignService.paymentInfo_TimeOut(id);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre><code>http://localhost/consumer/payment/hystrix/ok/1
</code></pre><p>导致原因</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596871816037.png" alt="1596871816037"></p><h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><p>超时导致服务器变慢（转圈）</p><ul><li>超时不在等待</li></ul><p>出错（宕机或程序运行出错）</p><ul><li>出错要有兜底</li></ul><p>方法：</p><blockquote><p>对方服务（8001）超时了，调用者（80）不能一直卡死等待，必须有服务降级</p><p>对方服务（8001）宕机了，调用者（80）不能一直卡死等待，必须有服务降级</p><p>对方服务（8001）OK，调用者（80）自己出故障或有自我要求（自己的等待时间小于服务提供者），自己处理降级</p></blockquote><h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><blockquote><p>服务器忙,请稍后再试,不让客户端等待并立刻返回一个友好提示,fallback</p></blockquote><p>哪些情况会触发降级</p><ul><li>程序运行异常</li><li>超时</li><li>服务熔断触发服务降级</li><li>线程池/信号量打满也会导致服务降级</li></ul><p>降级配置</p><blockquote><p>@HystrixCommand</p></blockquote><p>从Hystrix-8001找问题，设置自身调用超时时间的峰值，峰值内可以正常运行，超过了需要有兜底的方法处理，作服务降级fallback</p><p>修改8001的Service</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.service;

@Service
public class PaymentService {
    /**
     * 正常访问
     */
    public String paymentInfo_OK(Integer id) {
        return "线程池: " + Thread.currentThread().getName() + "  paymentInfo_OK,id:  " + id + "\t" + "O(∩_∩)O哈哈~";
    }

    /**
     * 超时访问，演示降级
     */
    @HystrixCommand(fallbackMethod = "paymentInfo_TimeOutHandler", commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000")
    })
    public String paymentInfo_TimeOut(Integer id) {
        //暂停3秒钟
        int timeNumber = 5;
        try {
            TimeUnit.SECONDS.sleep(timeNumber);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return "线程池: " + Thread.currentThread().getName() + "  paymentInfo_TimeOut,id:  " + id + "\t" + "o(╥﹏╥)o哭" + "耗时" + timeNumber + "秒钟";
    }

    public String paymentInfo_TimeOutHandler(Integer id) {
        return "调用支付接口超时或异常:\t" + "\t当前线程池名字" + Thread.currentThread().getName();
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一旦调用服务方法失败后并抛出错误信息后，会自动调用@HystrixCommand标注好的fallbackMethod调用类中指定的方法。</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这行代码表示3秒以内都是正常的逻辑。</p><p>修改8001的主启动类,开启降级</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@SpringBootApplication
@EnableEurekaClient
@EnableCircuitBreaker
public class PaymentHystrixMain8001 {
    public static void main(String[] args) {
        SpringApplication.run(PaymentHystrixMain8001.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试：</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">http://localhost:8001/payment/hystrix/timeout/1
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注释超时异常,制造 10/0 的异常也会降级. 当前服务不可用了,做服务降级,兜底的方案都是paymentInfo_TimeOutHandler.</p><p>让支付模块也支持Hystrix</p><p>修改cloud-consumer-feign-hystrix-order80的yaml: 添加</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">feign:
  hystrix:
    enabled: true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>修改启动类</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">@SpringBootApplication
@EnableFeignClients
@EnableHystrix
public class OrderHystrixMain80 {
    public static void main(String[] args) {
        SpringApplication.run(OrderHystrixMain80.class, args);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改Controller(客户端的等待是1.5秒)</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.controller;

@RestController
@Slf4j
public class OrderHystrixController {

    @Resource
    private PaymentHystrixService paymentFeignService;

    @GetMapping(value = "/consumer/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id) {
        return paymentFeignService.paymentInfo_OK(id);
    }

    @GetMapping(value = "/consumer/payment/hystrix/timeout/{id}")
    @HystrixCommand(fallbackMethod = "paymentInfo_TimeOutHandler", commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "1500")
    })
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
        return paymentFeignService.paymentInfo_TimeOut(id);
    }

    public String paymentTimeOutFallbackMethod(Integer id) {
        return "我是消费者80，对方支付系统繁忙请10秒钟后再试试或者自己运行出错请检查自己，o(╥﹏╥)o";
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试:</p><pre><code>http://localhost/consumer/payment/hystrix/timeout/1
</code></pre><p>如果修改paymentInfo_TimeOut超时错误为10/0,也会进入paymentTimeOutFallbackMethod</p><h3 id="全局服务降级"><a href="#全局服务降级" class="headerlink" title="全局服务降级"></a>全局服务降级</h3><h5 id="目前问题"><a href="#目前问题" class="headerlink" title="目前问题:"></a>目前问题:</h5><blockquote><p>每个业务方法对应一个兜底的方法,代码膨胀</p><p>统一和自定义的分开</p></blockquote><h5 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题:"></a>解决问题:</h5><p>@DefaultProperties(defaultFallback = “”)</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596896213076.png" alt="1596896213076"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596896313456.png" alt="1596896313456"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596896340233.png" alt="1596896340233"></p><p>修改cloud-consumer-feign-hystrix-order80的OrderHystrixController：</p><p>添加：@DefaultProperties(defaultFallback = “payment_Global_FallbackMethod”)</p><p>​ 和方法payment_Global_FallbackMethod</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.controller;

@RestController
@Slf4j
@DefaultProperties(defaultFallback = "payment_Global_FallbackMethod")
public class OrderHystrixController {

    @Resource
    private PaymentHystrixService paymentFeignService;

    @GetMapping(value = "/consumer/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id) {
        return paymentFeignService.paymentInfo_OK(id);
    }

     @GetMapping(value = "/consumer/payment/hystrix/timeout/{id}")
//    @HystrixCommand(fallbackMethod = "paymentTimeOutFallbackMethod", commandProperties = {
//     @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "1500")
//    })
    @HystrixCommand
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
        return paymentFeignService.paymentInfo_TimeOut(id);
    }

    public String paymentTimeOutFallbackMethod(Integer id) {
        return "我是消费者80，对方支付系统繁忙请10秒钟后再试试或者自己运行出错请检查自己，o(╥﹏╥)o";
    }

    //全局fallback方法
    public String payment_Global_FallbackMethod() {
        return "Global异常处理信息,请稍后再试,(⊙o⊙)…";
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再测试</p><pre><code>http://localhost/consumer/payment/hystrix/timeout/1
---------------------
Global异常处理信息,请稍后再试,(⊙o⊙)…
</code></pre><h3 id="通配服务降级FeignFallback"><a href="#通配服务降级FeignFallback" class="headerlink" title="通配服务降级FeignFallback"></a>通配服务降级FeignFallback</h3><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596898249818.png" alt="1596898249818"></p><p>修改cloud-consumer-feign-hystrix-order80，根据cloud-consumer-feign-hystrix-order80已经有的PaymentHystrixService接口，重新新建一个类(PaymentFallbackService)实现该接口，统一为接口里的方法进行异常处理。</p><blockquote><p>访问异常就访问实现类下的方法。</p></blockquote><p>新建实现类</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.service;

/**
 * @Author: Wizard
 * @Date: 2020/8/8 22:54
 */
@Component
public class PaymentFallbackService implements PaymentHystrixService {
    @Override
    public String paymentInfo_OK(Integer id) {
        return "----------PaymentFallbackService fall back,o(╥﹏╥)o\tpaymentInfo_OK";
    }

    @Override
    public String paymentInfo_TimeOut(Integer id) {
        return "----------PaymentFallbackService fall back,o(╥﹏╥)o\tpaymentInfo_TimeOut";
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml:添加</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">feign:
  hystrix:
    enabled: true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>接口修改注解：</p><p>@FeignClient(value = “CLOUD-PROVIDER-HYSTRIX-PAYMENT”, fallback = PaymentFallbackService.class)</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">package com.kayleh.springcloud.service;

/**
 * @Author: Wizard
 * @Date: 2020/8/7 20:54
 */
@Component
@FeignClient(value = "CLOUD-PROVIDER-HYSTRIX-PAYMENT", fallback = PaymentFallbackService.class)
public interface PaymentHystrixService {

    @GetMapping(value = "/payment/hystrix/ok/{id}")
    public String paymentInfo_OK(@PathVariable("id") Integer id);

    @GetMapping(value = "/payment/hystrix/timeout/{id}")
    public String paymentInfo_TimeOut(@PathVariable("id") Integer id);
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试：</p><pre><code>http://localhost/consumer/payment/hystrix/ok/1   -正常访问
关掉微服务8001
再访问http://localhost/consumer/payment/hystrix/ok/1  -fallback
</code></pre><p>此时服务端provider已经宕机，但是我们做了服务降级处理，让客户端在服务端不可用时也会获得提示信息而不会挂起耗死服务器。</p><h2 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h2><blockquote><p>类比保险丝达到最大服务器访问后,直接拒绝访问,拉闸限电,然后调用服务降级的方法并返回友好提示,break</p><p>保险丝. 服务降级—&gt;进而熔断—&gt;恢复调用链路</p></blockquote><h4 id="熔断机制概述"><a href="#熔断机制概述" class="headerlink" title="熔断机制概述"></a>熔断机制概述</h4><p>熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。</p><p>当检测到该节点微服务调用响应正常后，恢复调用链路。</p><p>在SpringCloud框架里，熔断机制通过hystrix实现。hystrix会监视微服务间调用的状况，</p><p>当失败的调用到一定阈值，缺省是5秒内20次调用失败，就会启动熔断机制。熔断机制的注解是@HystrixCommand.</p><h4 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h4><p>修改PaymentHystrixMain8001</p><p>修改PaymentService , 添加</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">    /**
     * 服务熔断
     */
    @HystrixCommand(fallbackMethod = "paymentCircuitBreaker_fallback", commandProperties = {
    @HystrixProperty(name = "circuitBreaker.enabled", value = "true"),//是否开启断路器
    @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),//请求次数
    @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value="10000"),//时间窗口期
    @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "60"),//失败率达到多少后跳闸
    })
    public String paymentCircuitBreaker(@PathVariable("id") Integer id) {

        if (id < 0) {
            throw new RuntimeException("******id 不能为负数");
        }
        String serialNumber = IdUtil.simpleUUID();

        return Thread.currentThread().getName() + "\t" + "调用成功,流水号:" + serialNumber;

    }

    public String paymentCircuitBreaker_fallback(@PathVariable("id") Integer id) {
        return "id 不能负数，请稍后再试，o(╥﹏╥)o  id:" + id;
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PaymentController,添加</p><pre class="line-numbers language-lang-java"><code class="language-lang-java"> // -----服务熔断
    @GetMapping("/payment/circuit/{id}")
    public String paymentCircuitBreaker(@PathVariable("id") Integer id) {
        String result = paymentService.paymentCircuitBreaker(id);
        log.info("****result:" + result);
        return result;
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre><code>http://localhost:8001/payment/circuit/1
http://localhost:8001/payment/circuit/-1
</code></pre><p>熔断类型</p><blockquote><p>熔断打开</p><p>请求不再进行调用当前服务,内部设置时钟一般为MTTR(平均故障处理时间),当打开时长达到所设时钟则进入半熔断状态.</p><p>熔断关闭</p><p>熔断关闭不会对服务进行熔断</p><p>熔断半开</p><p>部分请求根据规则调用当前服务,如果请求成功且符合规则则认为当前服务恢复正常,关闭熔断.</p></blockquote><p>断路器在什么情况下开始起作用:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596959205085.png" alt="1596959205085"></p><p>断路器打开或关闭的条件:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596959390685.png" alt="1596959390685"></p><p>断路器打开之后:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596959437485.png" alt="1596959437485"></p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%843/Blog/source/_posts/1.jpg" style="zoom:200%"></p><h4 id="Hystrix图形化DashBoard"><a href="#Hystrix图形化DashBoard" class="headerlink" title="Hystrix图形化DashBoard"></a>Hystrix图形化DashBoard</h4><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596960213699.png" alt="1596960213699"></p><p>新建cloud-consumer-hystrix-dashboard9001</p><p>pom.xml</p><pre class="line-numbers language-lang-xml"><code class="language-lang-xml">    <dependencies>
        <dependency>
            <groupid>org.springframework.cloud</groupid>
            <artifactid>spring-cloud-netflix-hystrix-dashboard</artifactid>
        </dependency>
        <dependency>
            <groupid>com.kayleh.springcloud</groupid>
            <artifactid>cloud-api-commons</artifactid>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-starter-web</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-actuator</artifactid>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-devtools</artifactid>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.projectlombok</groupid>
            <artifactid>lombok</artifactid>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupid>org.springframework.boot</groupid>
            <artifactid>spring-boot-test</artifactid>
            <scope>test</scope>
        </dependency>
    </dependencies>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml</p><pre class="line-numbers language-lang-yaml"><code class="language-lang-yaml">server:
    port: 9001
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>主启动类</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">/**
 * @Author: Wizard
 * @Date: 2020/8/3 18:10
 */
@SpringBootApplication
@EnableHystrixDashboard
public class HystrixDashboard9001 {
    public static void main(String[] args) {
        SpringApplication.run(HystrixDashboard9001.class, args);
    }

}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改cloud-provider-hystrix-payment8001的主启动类：添加</p><pre class="line-numbers language-lang-java"><code class="language-lang-java">/**
 * @Author: Wizard
 * @Date: 2020/8/3 18:10
 */
@SpringBootApplication
@EnableEurekaClient
@EnableCircuitBreaker
public class PaymentHystrixMain8001 {
    public static void main(String[] args) {
        SpringApplication.run(PaymentHystrixMain8001.class, args);
    }

    /**
     * 此配置是为了服务监控而配置，与服务容错本身无关，SpringCloud升级后的坑
     * ServletRegistrationBean因为springboot的默认路径不是"/hystrix.stream"
     * 只要在自己的项目配置上下面的servlet就可以了
     */
    @Bean
    public ServletRegistrationBean getServlet() {
        HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
        ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet);
        registrationBean.setLoadOnStartup(1);
        registrationBean.addUrlMappings("/hystrix.stream");
        registrationBean.setName("HystrixMetricsStreamServlet");
        return registrationBean;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre><code>http://localhost:9001/hystrix
</code></pre><p>配置9001监控8001</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596981678720.png" alt="1596981678720"></p><p>测试</p><pre><code>http://localhost:8001/payment/circuit/1
http://localhost:8001/payment/circuit/-1
</code></pre><p>七色:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596981829382.png" alt="1596981829382"></p><p>一圈:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596981876130.png" alt="1596981876130"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596981916733.png" alt="1596981916733"></p><p>一线:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1596981953995.png" alt="1596981953995"></p><p>整个图:</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/2.png" alt="1596981916733"></p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/3.png" alt="1596981916733"></p><p>流程图：</p><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/分布式的微服务架构3/1.jpg" alt="1596981916733"></p><p></p></div><div class="share"><span>공유하기</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=https://kayleh.top/分布式的微服务架构3/%20Kayleh%20Ribbon负载均衡服务调用、服务降级" target="_blank" rel="noopener" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%844/" title="GateWay服务限流"><i class="fa fa-angle-double-left"></i>&nbsp;이전 포스트: GateWay服务限流</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%842/" title="Eureka服务注册与发现">다음 포스트: Eureka服务注册与发现&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname="kayleh",disqus_identifier="分布式的微服务架构3/",disqus_title="Ribbon负载均衡服务调用、服务降级",disqus_url="https://kayleh.top/分布式的微服务架构3/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script id="dsq-count-scr" src="//kayleh.disqus.com/count.js" async></script></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="https://kayleh.top" rel="noopener noreferrer">Kayleh</a></p><span>visitors:<span id="busuanzi_value_site_pv"></span></span></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script><script src="/js/dao.js"></script><script src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/busuanzi/busuanzi.pure.mini.js"></script><script data-ad-client="ca-pub-7457165067653912" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></body></html>